var NEWOBJECTKEY="newObject";window.TEMPLATES={};window.REGISTER={};_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/\{\%(.+?)\%\}/g,};_.mixin(_.str.exports());function isEmpty(c){for(var b in c){return false}return true}var delay=(function(){if(DEBUG){console.log("function:delay")}var b=0;return function(d,c){clearTimeout(b);b=setTimeout(d,c)}})();function generatorID(e,h){if(DEBUG){console.log("function:generatorID")}var c=[];var f="i";var b=1000;var g=9999;var d=Math.floor(Math.random()*(g-b+1))+b;f+=$.now()+String(d);if(e){c.push(e)}c.push(f);if(h){c.push(h)}return validatorID(c)}function validatorID(b){if($.type(b)==="array"){b=b.join("_")}if(DEBUG){console.log("function:validatorID")}return b.replace(/[\.,\:,\/, ,\(,\),=,?]/g,"-")}function handlerHideAlert(){if(DEBUG){console.log("function:handlerHideAlert")}$(".alert").alert("close")}function handlerShowAlert(c,b,d){if(DEBUG){console.log("function:handlerShowAlert")}console.log(c);if(!b){b="alert-error"}html=TEMPLATES.alert({msg:c,type:b});$("#alert-place").html(html);$(window).scrollTop(0);$(".alert").alert();if(d){delay(d,5000)}else{delay(handlerHideAlert,5000)}return false}function jsonAPI(b,f,d,c){if(DEBUG){console.log("function:jsonAPI")}if(!b){var b={method:"get_settings"}}if(!f){f=function(h,g,i){}}var e=$.ajax({type:"POST",async:!c,timeout:AJAX_TIMEOUT,url:BWP_API_URL,data:"jsonData="+$.toJSON(b),dataType:"json"}).fail(function(i,g,h){if(i.getResponseHeader("Location")){window.location=i.getResponseHeader("Location").replace(/\?.*$/,"?next="+window.location.pathname);console.log("1:"+i.getResponseHeader("Location"))}else{console.log("ERROR:"+i.responseText);handlerShowAlert(_(i.responseText).truncate(255),"alert-error")}}).done(function(h,g,i){if(d){if(DEBUG){console.log(d)}}if((h.status>=300)&&(h.status<400)&&(h.data.Location)){handlerShowAlert(h.message,"alert-error",function(){window.location.href=h.data.Location.replace(/\?.*$/,"?next="+window.location.pathname)})}else{if(h.status>=400){handlerShowAlert(h.message,"alert-error")}else{if(DEBUG){console.log($.toJSON(h.message))}return f(h,g,i)}}});return e}function classSettings(b){if(DEBUG){console.log("function:Settings")}self=this;if(typeof localStorage=="undefined"||typeof $.evalJSON=="undefined"){return{}}_unique_key=SETTINGS_UNIQUE_KEY;_server={};_local={tabs:[],};_values={server:_server,local:_local};_values_is_set=false;_responseServer=null;this.__defineGetter__("ready",function(){return _values_is_set});_callback=b;_run_callback=function(){if(_callback){_callback();if(!_callback.__not_reset_after__){_callback=b}}};this.callback=_callback;_last_set_server=null;this.last_set=_last_set_server;_last_get_server=null;this.last_get=_last_get_server;_init=function(c){if(c){_callback=c}_values_is_set=false;_local=$.evalJSON(localStorage.getItem(_unique_key))||_local;_get_server();return self};this.init=_init;this.reload=_init;_check_init=function(){if(!_values_is_set){_init()}return self};this.__defineGetter__("all",function(){_check_init();return _values});this.__defineGetter__("server",function(){_check_init();return _server});this.__defineGetter__("local",function(){_check_init();return _local});this.save=function(d,c){if(d){_callback=d}if(c!="local"){_set_server()}if(c!="server"){localStorage.setItem(_unique_key,$.toJSON(self.local))}_run_callback();return self};this.save_server=function(c){return self.save(c,"server")};this.save_local=function(c){return self.save(c,"local")};_set_server=function(){sync=false;_responseServer=null;args={method:"set_settings",settings:self.server};cb=function(d,c,e){if(!d.data){handlerShowAlert(d.message)}else{_last_set_server=new Date();_responseServer=d}};jqxhr=new jsonAPI(args,cb,"SETTINGS.set_server() call jsonAPI()",sync);return[_last_set_server,_responseServer,jqxhr]};_get_server=function(){sync=true;_responseServer=null;args={method:"get_settings"};cb=function(d,c,e){_server=d.data;_last_get_server=new Date();_responseServer=d;_values_is_set=true;_run_callback()};jqxhr=new jsonAPI(args,cb,"SETTINGS.get_server() call jsonAPI()",sync);return[_last_get_server,_responseServer,jqxhr]};this.cleanTabs=function(){_tabs=[];$.each(_local.tabs,function(c,d){if(d){_tabs.push(d)}});_local.tabs=_tabs;return self}}function classApp(b){this.has_module_perms=b.has_module_perms;this.name=b.name;this.id=validatorID(this.name);this.label=b.label;this.title="Приложение:"+this.label;_models=[];this.models=_models;app=this;$.each(b.models,function(c,d){_models.push(new classModel(app,d))});REGISTER[this.id]=this}function classModel(c,b){this.app=c;this.perms=b.perms;this.meta=b.meta;this.name=b.name;this.model=this.name;this.id=validatorID(this.model);this.label=b.label;this.title=this.app.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;_composes={};this.composes=_composes;_widgets=[];this.widgets=_widgets;model=this;if(b.meta.compositions){$.each(b.meta.compositions,function(d,e){_composes[e.meta.related_name]=e})}$.each(model.meta.list_display,function(e,d){if(d=="__unicode__"){_widgets.push({name:d,label:model.label,attr:{}})}else{$.each(model.meta.widgets,function(f,g){if(d==g.name){_widgets.push(g)}})}});REGISTER[this.id]=this}function classCompose(b,c){this.object=b;this.editable=Boolean(this.object.pk);this.perms=c.perms;this.meta=c.meta;this.name=this.meta.related_name;this.compose=this.name;this.model=this.meta.related_model;this.id=validatorID([this.object.id,this.name]);this.label=c.label;this.title=this.object.label+": "+this.label;this.query=null;this.fix={};this.paginator=null;_widgets=[];this.widgets=_widgets;compose=this;$.each(compose.meta.list_display,function(e,d){if(d=="__unicode__"){_widgets.push({name:d,label:compose.label,attr:{}})}else{$.each(compose.meta.widgets,function(f,g){if(d==g.name){_widgets.push(g)}})}});REGISTER[this.id]=this}function classObject(b){this.model=REGISTER[validatorID(b.model)];this.pk=b.pk;this.id=this.pk?validatorID(b.model+"."+this.pk):generatorID(NEWOBJECTKEY);this.__unicode__=b.__unicode__;this.label=this.__unicode__;this.title=this.model.label+": "+this.label;_fields=b.fields;this.fields=_fields;_composes=[];this.composes=_composes;this.widgets=this.model.meta.widgets;this.fix={};this.fixaction=null;object=this;if(this.model.composes){$.each(this.model.composes,function(c,d){_composes.push(new classCompose(object,d))})}REGISTER[this.id]=this}function handlerCollectionRender(b){if(DEBUG){console.log("function:handlerCollectionRender")}if(b instanceof classObject){return""}html=TEMPLATES.collection({data:b});$("#collection_"+b.id).html(html);return html}function handlerLayoutRender(b){if(DEBUG){console.log("function:handlerLayoutRender")}if(b instanceof classModel){template=TEMPLATES.layoutModel}else{if(b instanceof classCompose){template=TEMPLATES.layoutCompose}else{if(b instanceof classObject){template=TEMPLATES.layoutObject}}}html=template({data:b});$("#layout_"+b.id).html(html);if(b instanceof classObject){$("#layout_"+b.id+" button[data-loading=true]").one("click",eventLayoutLoad)}return html}function handlerCommitInstance(b){if(DEBUG){console.log("function:handlerCommitInstance")}console.log(instance);is_changed=false;_objects=[];_model=instance.model;appendObject=function(c){if((!isEmpty(c.fix))||(c.fixaction=="delete")){$.extend(true,c.fields,c.fix);_objects.push({pk:c.pk,fields:c.fields,model:c.model.model,action:c.fixaction})}};if((instance instanceof classModel)||(instance instanceof classCompose)){_model=instance;$.each(instance.fix,function(c,d){appendObject(d)})}else{console.log(instance);appendObject(instance)}args={method:"commit",objects:_objects,};cb=function(d,c,e){handlerCollectionGet(_model)};jqxhr=new jsonAPI(args,cb,"handlerCommitInstance(instanse) call jsonAPI()");return jqxhr}function handlerObjectAdd(b,c){if(DEBUG){console.log("function:handlerObjectAdd")}_data={};_data.model=b.model;_data.fields=b.meta.fields;_data.__unicode__="Новый объект";data={};$.extend(true,data,_data);newobject=new classObject(data);$.extend(true,newobject.fix,newobject.fields);newobject.fixaction="add";newobject.model.fix[newobject.id]=newobject;c.data("id",newobject.id);handlerTabOpen(newobject);return newobject}function handlerObjectChange(c,d){if(DEBUG){console.log("function:handlerObjectChange")}var b=d.attr("name");var e=d.val();if($.type(c.fields[b])==="array"){e=[e,d.text()]}c.fix[b]=e;c.fixaction=c.fixaction||"change";c.model.fix[c.id]=c}function handlerObjectCopy(b,c){if(DEBUG){console.log("function:handlerObjectCopy")}create=function(d){_data={};_data.model=d.model.model;_data.fields=d.fields;_data.__unicode__=d.__unicode__;data={};$.extend(true,data,_data);newobject=new classObject(data);$.extend(true,newobject.fix,newobject.fields);newobject.fixaction="add";newobject.model.fix[newobject.id]=newobject;c.data("id",newobject.id);handlerTabOpen(newobject);return newobject};if(b){create(b)}else{args={method:"get_object",model:data.model,pk:data.pk||null,};cb=function(e,d,f){b=new classObject(e.data);newobject=create(b);c.data("id",newobject.id);handlerTabOpen(newobject)};jqxhr=new jsonAPI(args,cb,"handlerObjectCopy(object) call jsonAPI()")}}function handlerObjectDelete(b,c){if(DEBUG){console.log("function:handlerObjectDelete")}args={method:"commit",objects:[{pk:b.pk,fields:{},model:b.model,action:"delete"}],};cb=function(e,d,f){handlerCollectionGet(REGISTER[validatorID(b.model)])};jqxhr=new jsonAPI(args,cb,"handlerObjectDelete() call jsonAPI()")}function eventObjectOpen(){if(DEBUG){console.log("function:eventObjectOpen")}$this=$(this);data=$this.data();if(!data.model){return false}object=REGISTER[data.id];if(object){handlerTabOpen(object);return null}args={method:"get_object",model:data.model,pk:data.pk||null,};cb=function(c,b,d){object=new classObject(c.data);$this.data("id",object.id);handlerTabOpen(object)};jqxhr=new jsonAPI(args,cb,"eventObjectOpen() call jsonAPI()");return jqxhr}function eventObjectAdd(){if(DEBUG){console.log("function:eventObjectAdd")}$this=$(this);data=$this.data();model=REGISTER[data.id];console.log(model);handlerObjectAdd(model,$this);return true}function eventObjectCopy(){if(DEBUG){console.log("function:eventObjectCopy")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerObjectCopy(object,$this);return true}function eventObjectDelete(){if(DEBUG){console.log("function:eventObjectDelete")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerObjectDelete(data,$this);return true}function eventObjectChange(){if(DEBUG){console.log("function:eventObjectChange")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerObjectChange(object,$this);return true}function eventObjectReset(){if(DEBUG){console.log("function:eventObjectReset")}$this=$(this);data=$this.data();object=REGISTER[data.id];object.fix={};handlerLayoutRender(object);return true}function eventObjectSave(){if(DEBUG){console.log("function:eventObjectSave")}$this=$(this);data=$this.data();object=REGISTER[data.id];handlerCommitInstance(object);return true}function handlerObjectRowMuted(b){if(DEBUG){console.log("function:handlerObjectRowMuted")}$('tr[data-model="'+b.model.name+'"][data-pk="'+b.pk+'"]').addClass("muted")}function handlerObjectRowUnmuted(b){if(DEBUG){console.log("function:handlerObjectRowUnmuted")}$('tr[data-model="'+b.model.name+'"][data-pk="'+b.pk+'"]').removeClass("muted")}function handlerCollectionGet(b){if(DEBUG){console.log("function:handlerCollectionGet")}args={method:"get_collection",model:b.model,compose:b.compose||null,order_by:b.meta.ordering||null,};args[b.meta.search_key]=b.query||null;if(b.object){args.pk=b.object.pk||0}if(b.paginator){args.page=b.paginator.page||1;args.per_page=b.paginator.per_page||null}cb=function(d,c,e){b.paginator=d.data;html=handlerCollectionRender(b)};jqxhr=new jsonAPI(args,cb,"handlerCollectionGet() call jsonAPI()");return jqxhr}function eventCollectionFilter(){if(DEBUG){console.log("function:eventCollectionFilter")}search=this;data=$(search).data();instance=REGISTER[data.id];instance.query=$(search).val()||null;jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionCount(){if(DEBUG){console.log("function:eventCollectionCount")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=1;instance.paginator.per_page=$(this).val()||$(this).data()["count"]||instance.meta.list_per_page;$("[data-placeholder=collection_count][data-id="+instance.id+"]").text(instance.paginator.per_page)}jqxhr=handlerCollectionGet(instance);return jqxhr}function eventCollectionPage(){if(DEBUG){console.log("function:eventCollectionPage")}data=$(this).data();instance=REGISTER[data.id];if(instance.paginator){instance.paginator.page=$(this).val()||$(this).data()["page"]||1}jqxhr=handlerCollectionGet(instance);return jqxhr}function handlerMenuAppLoad(){if(DEBUG){console.log("function:handlerMenuAppLoad")}sync=true;args={method:"get_apps"};cb=function(c,b,d){apps=[];$.each(c.data,function(e,f){apps.push(new classApp(f))});html=TEMPLATES.menuApp({data:apps});$("#menu-app ul[role=menu]").html(html);$("#menu-app").show()};jqxhr=new jsonAPI(args,cb,"handlerMenuAppLoad() call jsonAPI()",sync);return jqxhr}function handlerTabOpen(b){if(DEBUG){console.log("function:handlerTabOpen")}handlerObjectRowMuted(b);tab=$("#main-tab #tab_"+b.id);if(tab.length>0){tab.find("a").tab("show")}else{html=TEMPLATES.layoutDefault({data:b});$("#main-tab-content").append(html);html=TEMPLATES.tab({data:b});$("#main-tab").append(html);delay(function(){$("#main-tab a:last").tab("show").click()},1);if((b.id.indexOf(NEWOBJECTKEY)==-1)&&($.inArray(b.id,SETTINGS.local.tabs)<0)){SETTINGS.local.tabs.push(b.id);SETTINGS.save_local()}a=$("#tab_"+b.id+" a").one("click",eventLayoutLoad)}return true}function eventTabOpen(){if(DEBUG){console.log("function:eventTabOpen")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabOpen(data);return true}function handlerTabClose(b){if(DEBUG){console.log("function:handlerTabClose")}$("#tab_"+b.id).remove();$("#layout_"+b.id).remove();instance=REGISTER[b.id];if(instance){handlerObjectRowUnmuted(instance);if(instance instanceof classObject){delete REGISTER[b.id]}}num=$.inArray(b.id,SETTINGS.local.tabs);if(num>-1){delete SETTINGS.local.tabs[num];SETTINGS.cleanTabs().save_local()}}function eventTabClose(){if(DEBUG){console.log("function:eventTabClose")}data=$(this).data();data=REGISTER[data.id]||data;handlerTabClose(data);return true}function handlerLayoutLoad(b){if(DEBUG){console.log("function:handlerLayoutLoad")}html=handlerLayoutRender(b);if((b instanceof classModel)||(b instanceof classCompose)){jqxhr=handlerCollectionGet(b)}}function eventLayoutLoad(){if(DEBUG){console.log("function:eventLayoutLoad")}data=$(this).data();instance=REGISTER[data.id];handlerLayoutLoad(instance);$(this).removeAttr("data-loading");return true}function restoreSession(){if(DEBUG){console.log("function:restoreSession")}$.each(SETTINGS.local.tabs,function(b,c){$("#menu-app li[class!=disabled] a[data-id="+c+"]").click()})}$(document).ready(function(b){if(DEBUG){console.log("function:$(document).ready")}TEMPLATES.alert=_.template(b("#underscore-alert").html());TEMPLATES.menuApp=_.template(b("#underscore-menu-app").html());TEMPLATES.collection=_.template(b("#underscore-collection").html());TEMPLATES.layoutModel=_.template(b("#underscore-layout-model").html());TEMPLATES.layoutCompose=_.template(b("#underscore-layout-compose").html());TEMPLATES.layoutObject=_.template(b("#underscore-layout-object").html());TEMPLATES.layoutDefault=_.template(b("#underscore-layout-default").html());TEMPLATES.tab=_.template(b("#underscore-tab").html());b("#menu-app").hide();b("#menu-func").hide();handlerMenuAppLoad();window.SETTINGS=new classSettings();b("alert").alert();b(".dropdown-toggle").dropdown();if(SETTINGS.init().ready){b("#search").focus();b("#menu-app li[class!=disabled]").on("click","a",eventTabOpen);b("#main-tab").on("click","button.close[data-id]",eventTabClose);restoreSession();b("body").on("keyup","[data-action=collection_filter]",eventCollectionFilter);b("body").on("change","[data-action=collection_filter]",eventCollectionFilter);b("body").on("click","[data-action=collection_count]",eventCollectionCount);b("body").on("change","[data-action=collection_page]",eventCollectionPage);b("body").on("click","[data-action=collection_page]",eventCollectionPage);b("body").on("click","[data-action=object_open]",eventObjectOpen);b("body").on("click","[data-action=object_add]",eventObjectAdd);b("body").on("click","[data-action=object_copy]",eventObjectCopy);b("body").on("click","[data-action=object_delete]",eventObjectDelete);b("body").on("keyup","[data-action=object_change]",eventObjectChange);b("body").on("change","[data-action=object_change]",eventObjectChange);b("body").on("click","[data-action=object_reset]",eventObjectReset);b("body").on("click","[data-action=object_save]",eventObjectSave)}else{console.log("ОШИБКА! Загрузка настроек не удалась.")}});